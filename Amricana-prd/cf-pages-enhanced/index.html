<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة توزيع الحلويات الذكية - SSDP Ultimate</title>
    <meta name="description" content="منصة توزيع الحلويات الذكية المدعومة بالذكاء الاصطناعي - رؤية المملكة 2030">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary: #f4511e; --secondary: #0a192f; --accent: #0ea5e9; --success: #10b981; --warning: #f59e0b; --error: #ef4444;
            --glass: rgba(255,255,255,0.1); --glass-border: rgba(255,255,255,0.2); --glass-dark: rgba(10,25,47,0.1);
            --transition: 0.3s cubic-bezier(0.4,0,0.2,1); --transition-slow: 0.5s cubic-bezier(0.4,0,0.2,1);
            --shadow: 0 8px 32px rgba(0,0,0,0.1); --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
            color: #1a365d; direction: rtl; overflow-x: hidden;
            transition: all var(--transition);
        }
        [data-theme="dark"] body { 
            background: linear-gradient(135deg, var(--secondary) 0%, #000000 100%); 
            color: white; 
        }
        .loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            display: flex; align-items: center; justify-content: center; z-index: 9999;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loading-content { text-align: center; color: white; }
        .loading-logo { font-size: 5rem; margin-bottom: 2rem; animation: pulse 2s infinite; }
        .loading-text { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
        .loading-subtitle { font-size: 1rem; opacity: 0.9; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .header { 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 80px;
            background: var(--glass); backdrop-filter: blur(20px); 
            border-bottom: 1px solid var(--glass-border);
        }
        .header-content { 
            display: flex; align-items: center; justify-content: space-between; 
            height: 100%; padding: 0 2rem; max-width: 1400px; margin: 0 auto; 
        }
        .brand { display: flex; align-items: center; gap: 1rem; }
        .brand-icon { 
            width: 50px; height: 50px; 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            border-radius: 15px; display: flex; align-items: center; justify-content: center; 
            font-size: 2rem; color: white; animation: rotate 10s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .brand-text h1 { font-size: 1.5rem; font-weight: 700; color: var(--secondary); }
        [data-theme="dark"] .brand-text h1 { color: white; }
        .brand-text p { font-size: 0.875rem; color: var(--primary); font-weight: 500; }
        .nav { display: flex; gap: 0.5rem; }
        .nav-btn { 
            background: none; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; 
            cursor: pointer; transition: var(--transition); font-weight: 500;
        }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn:hover:not(.active) { background: var(--glass); }
        .controls { display: flex; gap: 1rem; }
        .control-btn { 
            background: none; border: none; padding: 0.75rem; border-radius: 12px; 
            cursor: pointer; font-size: 1.25rem; transition: var(--transition); position: relative;
        }
        .control-btn:hover { background: var(--glass); transform: scale(1.05); }
        .notification-badge { 
            position: absolute; top: 0; right: 0; width: 20px; height: 20px; 
            background: var(--primary); color: white; border-radius: 50%; 
            font-size: 0.75rem; display: flex; align-items: center; justify-content: center;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); } 40%, 43% { transform: translate3d(0, -8px, 0); } 70% { transform: translate3d(0, -4px, 0); } 90% { transform: translate3d(0,-2px,0); } }
        .main { margin-top: 80px; padding: 2rem; min-height: calc(100vh - 80px); }
        .hero { 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            border-radius: 24px; padding: 3rem; text-align: center; color: white; 
            margin-bottom: 3rem; position: relative; overflow: hidden;
        }
        .hero::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        .hero-content { position: relative; z-index: 1; }
        .hero h1 { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; animation: slideInDown 1s ease-out; }
        .hero p { font-size: 1.25rem; opacity: 0.9; margin-bottom: 2rem; animation: slideInUp 1s ease-out 0.2s both; }
        .badge { 
            display: inline-flex; align-items: center; gap: 0.5rem; 
            background: rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
            border-radius: 25px; font-weight: 600; animation: slideInUp 1s ease-out 0.4s both;
        }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .floating-elements { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        .floating-icon { position: absolute; font-size: 2.5rem; opacity: 0.3; animation: float 6s ease-in-out infinite; }
        .floating-icon:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
        .floating-icon:nth-child(2) { top: 60%; left: 80%; animation-delay: 2s; }
        .floating-icon:nth-child(3) { top: 30%; left: 70%; animation-delay: 4s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
        .section { display: none; animation: fadeIn 0.5s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .kpi-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 2rem; margin-bottom: 3rem; 
        }
        .kpi-card { 
            background: var(--glass); backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); border-radius: 24px; 
            padding: 2rem; position: relative; overflow: hidden; 
            transition: var(--transition); cursor: pointer;
        }
        .kpi-card::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            transform: scaleX(0); transition: transform var(--transition);
        }
        .kpi-card:hover::before { transform: scaleX(1); }
        .kpi-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .kpi-icon { font-size: 3rem; margin-bottom: 1rem; animation: bounce 2s infinite; }
        .kpi-value { 
            font-size: 2.5rem; font-weight: 700; color: var(--secondary); 
            margin-bottom: 0.5rem; font-family: 'Courier New', monospace;
        }
        [data-theme="dark"] .kpi-value { color: white; }
        .kpi-label { font-size: 1rem; color: #64748b; margin-bottom: 1rem; }
        .kpi-trend { 
            font-size: 0.875rem; font-weight: 600; padding: 0.5rem 1rem; 
            border-radius: 20px; display: inline-block;
        }
        .kpi-trend.positive { background: rgba(16,185,129,0.1); color: var(--success); }
        .kpi-trend.negative { background: rgba(239,68,68,0.1); color: var(--error); }
        .telemetry { 
            position: absolute; top: 1rem; right: 1rem; 
            background: rgba(0,0,0,0.8); color: white; 
            padding: 0.25rem 0.75rem; border-radius: 12px; 
            font-size: 0.75rem; font-family: 'Courier New', monospace;
        }
        .dashboard-grid { 
            display: grid; grid-template-columns: 2fr 1fr; 
            gap: 2rem; margin-bottom: 3rem; 
        }
        .dashboard-card { 
            background: var(--glass); backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); border-radius: 24px; 
            padding: 2rem; position: relative; overflow: hidden;
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1.5rem; 
        }
        .card-header h3 { font-size: 1.25rem; font-weight: 600; color: var(--secondary); }
        [data-theme="dark"] .card-header h3 { color: white; }
        .live-indicator { 
            display: flex; align-items: center; gap: 0.5rem; 
            font-size: 0.875rem; font-weight: 500; color: var(--primary);
        }
        .live-dot { 
            width: 8px; height: 8px; background: var(--primary); 
            border-radius: 50%; animation: pulse 2s infinite;
        }
        .map-container { position: relative; height: 400px; border-radius: 12px; overflow: hidden; }
        .map-placeholder { 
            width: 100%; height: 100%; 
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.125rem; color: #64748b;
        }
        .analytics-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 2rem; 
        }
        .analytics-card { 
            background: var(--glass); backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); border-radius: 16px; 
            padding: 2rem; text-align: center; transition: var(--transition);
        }
        .analytics-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        .analytics-card h3 { 
            font-size: 1.25rem; font-weight: 600; 
            color: var(--secondary); margin-bottom: 1rem; 
        }
        [data-theme="dark"] .analytics-card h3 { color: white; }
        .analytics-card p { color: #64748b; line-height: 1.5; }
        .products-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }
        .product-card { 
            background: var(--glass); backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); border-radius: 16px; 
            padding: 1.5rem; text-align: center; transition: var(--transition);
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        .product-image { 
            font-size: 3rem; margin-bottom: 1rem; 
            animation: bounce 2s infinite; animation-delay: calc(var(--i) * 0.1s);
        }
        .product-name { 
            font-size: 1.125rem; font-weight: 600; 
            color: var(--secondary); margin-bottom: 0.5rem; 
        }
        [data-theme="dark"] .product-name { color: white; }
        .product-description { 
            font-size: 0.875rem; color: #64748b; 
            margin-bottom: 1rem; line-height: 1.4; 
        }
        .product-meta { 
            display: flex; justify-content: space-between; 
            align-items: center; 
        }
        .product-price { 
            font-size: 1.25rem; font-weight: 700; 
            color: var(--primary); 
        }
        .product-stock { font-size: 0.875rem; color: var(--success); }
        .product-stock.low { color: var(--warning); }
        .product-stock.out { color: var(--error); }
        .loading { 
            display: flex; align-items: center; justify-content: center; 
            padding: 3rem; color: #64748b; font-size: 1.125rem;
        }
        .spinner { 
            width: 32px; height: 32px; 
            border: 3px solid var(--glass-border); 
            border-top: 3px solid var(--primary); 
            border-radius: 50%; animation: spin 1s linear infinite; 
            margin-left: 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { 
            position: fixed; top: 100px; right: 20px; z-index: 10000;
            padding: 1rem 1.5rem; border-radius: 12px; 
            box-shadow: var(--shadow); font-size: 0.875rem; font-weight: 500;
            animation: slideInRight 0.3s ease-out; max-width: 300px;
        }
        .notification.success { background: var(--success); color: white; }
        .notification.error { background: var(--error); color: white; }
        .notification.warning { background: var(--warning); color: white; }
        .notification.info { background: var(--accent); color: white; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: none; align-items: center; 
            justify-content: center; z-index: 10000;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; border-radius: 24px; padding: 2rem; 
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        [data-theme="dark"] .modal-content { background: var(--secondary); color: white; }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @media (max-width: 1024px) { 
            .dashboard-grid { grid-template-columns: 1fr; }
            .nav { display: none; }
        }
        @media (max-width: 768px) { 
            .hero h1 { font-size: 2rem; }
            .hero p { font-size: 1rem; }
            .kpi-grid { grid-template-columns: 1fr; gap: 1rem; }
            .main { padding: 1rem; }
            .header-content { padding: 0 1rem; }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">🧠🍯</div>
            <div class="loading-text">جاري تحميل منصة توزيع الحلويات الذكية</div>
            <div class="loading-subtitle">مدعومة من BrainSAIT - رؤية المملكة 2030</div>
        </div>
    </div>
    <header class="header">
        <div class="header-content">
            <div class="brand">
                <div class="brand-icon">🧠</div>
                <div class="brand-text">
                    <h1>SSDP Ultimate</h1>
                    <p>الذكاء الاصطناعي للحلويات</p>
                </div>
            </div>
            <nav class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')" data-section="dashboard">📊 لوحة التحكم</button>
                <button class="nav-btn" onclick="showSection('products')" data-section="products">🍬 المنتجات</button>
                <button class="nav-btn" onclick="showSection('analytics')" data-section="analytics">📈 التحليلات</button>
                <button class="nav-btn" onclick="showSection('map')" data-section="map">🗺️ الخريطة</button>
            </nav>
            <div class="controls">
                <button class="control-btn" onclick="toggleLang()" title="تغيير اللغة">🌐</button>
                <button class="control-btn" onclick="toggleTheme()" title="تغيير المظهر">🌙</button>
                <button class="control-btn" onclick="showNotifications()" title="الإشعارات">
                    🔔
                    <span class="notification-badge">5</span>
                </button>
                <button class="control-btn" onclick="showProfile()" title="الملف الشخصي">👤</button>
            </div>
        </div>
    </header>

    <main class="main">
        <section id="dashboard" class="section active">
            <div class="hero">
                <div class="hero-content">
                    <h1>منصة توزيع الحلويات الذكية</h1>
                    <p>تمكين سوق توزيع الحلويات في المملكة العربية السعودية بالذكاء الاصطناعي</p>
                    <div class="badge">🇸🇦 رؤية المملكة 2030 - التحول الرقمي</div>
                </div>
                <div class="floating-elements">
                    <div class="floating-icon">🍰</div>
                    <div class="floating-icon">🧁</div>
                    <div class="floating-icon">🍯</div>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card" onclick="showKPIDetails('sales')">
                    <div class="kpi-icon">💰</div>
                    <div class="kpi-value" id="sales">125,430</div>
                    <div class="kpi-label">إجمالي المبيعات اليوم</div>
                    <div class="kpi-trend positive">+12.5% ↗</div>
                    <div class="telemetry">LIVE</div>
                </div>
                <div class="kpi-card" onclick="showKPIDetails('vehicles')">
                    <div class="kpi-icon">🚛</div>
                    <div class="kpi-value" id="vehicles">24</div>
                    <div class="kpi-label">المركبات النشطة</div>
                    <div class="kpi-trend positive">+2 ↗</div>
                    <div class="telemetry">GPS</div>
                </div>
                <div class="kpi-card" onclick="showKPIDetails('customers')">
                    <div class="kpi-icon">👥</div>
                    <div class="kpi-value" id="customers">1,234</div>
                    <div class="kpi-label">العملاء النشطون</div>
                    <div class="kpi-trend positive">+5.2% ↗</div>
                    <div class="telemetry">AI</div>
                </div>
                <div class="kpi-card" onclick="showKPIDetails('orders')">
                    <div class="kpi-icon">📦</div>
                    <div class="kpi-value" id="orders">89</div>
                    <div class="kpi-label">الطلبات المكتملة</div>
                    <div class="kpi-trend positive">+8.1% ↗</div>
                    <div class="telemetry">SYNC</div>
                </div>
                <div class="kpi-card" onclick="showKPIDetails('products-count')">
                    <div class="kpi-icon">🍬</div>
                    <div class="kpi-value" id="products-count">17</div>
                    <div class="kpi-label">المنتجات المتاحة</div>
                    <div class="kpi-trend positive">+15 ↗</div>
                    <div class="telemetry">DB</div>
                </div>
                <div class="kpi-card" onclick="showKPIDetails('collection')">
                    <div class="kpi-icon">💳</div>
                    <div class="kpi-value" id="collection">92.5%</div>
                    <div class="kpi-label">معدل التحصيل</div>
                    <div class="kpi-trend positive">+3.2% ↗</div>
                    <div class="telemetry">ZATCA</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>📈 تحليلات المبيعات المباشرة</h3>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>مباشر</span>
                        </div>
                    </div>
                    <div id="sales-chart" style="height: 300px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px;">
                        <div style="text-align: center; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                            <div>رسم بياني تفاعلي للمبيعات</div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>🤖 رؤى الذكاء الاصطناعي</h3>
                        <div class="live-indicator">
                            <div class="live-dot" style="background: var(--success);"></div>
                            <span style="color: var(--success);">نشط</span>
                        </div>
                    </div>
                    <div id="ai-insights">
                        <div style="padding: 1rem; margin-bottom: 1rem; background: rgba(16,185,129,0.1); border-radius: 12px; border-right: 4px solid var(--success);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">🎯</span>
                                <strong>توقع الطلب</strong>
                            </div>
                            <p style="font-size: 0.875rem; color: #64748b;">زيادة متوقعة 25% في طلب الكنافة خلال الأسبوع القادم</p>
                        </div>
                        <div style="padding: 1rem; margin-bottom: 1rem; background: rgba(14,165,233,0.1); border-radius: 12px; border-right: 4px solid var(--accent);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">🚛</span>
                                <strong>تحسين المسارات</strong>
                            </div>
                            <p style="font-size: 0.875rem; color: #64748b;">يمكن توفير 15% من وقت التوصيل بتحسين مسار المنطقة الشرقية</p>
                        </div>
                        <div style="padding: 1rem; background: rgba(245,158,11,0.1); border-radius: 12px; border-right: 4px solid var(--warning);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">💡</span>
                                <strong>فرصة تجارية</strong>
                            </div>
                            <p style="font-size: 0.875rem; color: #64748b;">3 منافذ جديدة في الرياض تظهر إمكانية عالية للنجاح</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="products" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--secondary);">🍬 إدارة المنتجات</h2>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="refreshProducts()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 500;">🔄 تحديث</button>
                    <button onclick="addProduct()" style="background: var(--success); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 500;">+ إضافة منتج</button>
                </div>
            </div>
            <div id="products-grid" class="products-grid">
                <div class="loading">
                    جاري تحميل المنتجات...
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <section id="analytics" class="section">
            <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--secondary); margin-bottom: 2rem;">📈 التحليلات والتقارير المتقدمة</h2>
            <div class="analytics-grid">
                <div class="analytics-card" onclick="showAnalyticsDetail('sales')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                    <h3>تحليل المبيعات</h3>
                    <p>تقارير مفصلة عن أداء المبيعات والاتجاهات مع التنبؤات الذكية</p>
                </div>
                <div class="analytics-card" onclick="showAnalyticsDetail('vehicles')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🚛</div>
                    <h3>أداء المركبات</h3>
                    <p>تتبع كفاءة التوصيل والمسارات المحسنة مع تحليل استهلاك الوقود</p>
                </div>
                <div class="analytics-card" onclick="showAnalyticsDetail('customers')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                    <h3>رضا العملاء</h3>
                    <p>مؤشرات رضا العملاء وتحليل التغذية الراجعة مع توقع الاحتياجات</p>
                </div>
                <div class="analytics-card" onclick="showAnalyticsDetail('inventory')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📦</div>
                    <h3>إدارة المخزون</h3>
                    <p>تحليل مستويات المخزون والتنبؤ بالطلب مع التنبيهات الذكية</p>
                </div>
                <div class="analytics-card" onclick="showAnalyticsDetail('financial')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">💰</div>
                    <h3>التحليل المالي</h3>
                    <p>تقارير الربحية والتدفق النقدي مع توقعات النمو المستقبلي</p>
                </div>
                <div class="analytics-card" onclick="showAnalyticsDetail('ai')">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🤖</div>
                    <h3>الذكاء الاصطناعي</h3>
                    <p>رؤى متقدمة مدعومة بالذكاء الاصطناعي لتحسين الأداء</p>
                </div>
            </div>
        </section>

        <section id="map" class="section">
            <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--secondary); margin-bottom: 2rem;">🗺️ العمليات المباشرة</h2>
            <div class="dashboard-card">
                <div class="card-header">
                    <h3>خريطة العمليات التفاعلية</h3>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>مباشر</span>
                    </div>
                </div>
                <div class="map-container">
                    <div id="operations-map" class="map-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">🗺️</div>
                            <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">خريطة العمليات التفاعلية</div>
                            <div style="font-size: 0.875rem;">تتبع المركبات والمنافذ والتوصيلات في الوقت الفعلي</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 id="modal-title">تفاصيل</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            <div id="modal-body">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class SSDPUltimate {
            constructor() {
                this.apiBase = 'https://ssdp-api.dr-mf-12298.workers.dev/api';
                this.currentLang = 'ar';
                this.currentTheme = 'light';
                this.cache = new Map();
                this.map = null;
                this.realTimeInterval = null;
                this.init();
            }

            async init() {
                try {
                    this.setupEventListeners();
                    await this.loadInitialData();
                    this.initializeMap();
                    this.startRealTimeUpdates();
                    this.hideLoadingScreen();
                } catch (error) {
                    console.error('SSDP Ultimate initialization failed:', error);
                    this.hideLoadingScreen();
                    this.showNotification('حدث خطأ في تهيئة النظام', 'error');
                }
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'k': e.preventDefault(); this.showSearch(); break;
                            case 'd': e.preventDefault(); this.toggleTheme(); break;
                            case 'l': e.preventDefault(); this.toggleLang(); break;
                        }
                    }
                    if (e.key === 'Escape') this.closeModal();
                });

                window.addEventListener('resize', () => this.handleResize());
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
            }

            async loadInitialData() {
                try {
                    const [analyticsData, productsData] = await Promise.all([
                        this.apiCall('/analytics/dashboard').catch(() => ({ success: false, data: this.getFallbackAnalytics() })),
                        this.apiCall('/products').catch(() => ({ success: false, products: [] }))
                    ]);

                    if (analyticsData.success || analyticsData.data) {
                        this.updateKPIDashboard(analyticsData.data || analyticsData);
                    } else {
                        this.updateKPIDashboard(this.getFallbackAnalytics());
                    }

                    if (productsData.success && productsData.products) {
                        this.renderProducts(productsData.products);
                        this.updateProductCount(productsData.total || productsData.products.length);
                    }
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.updateKPIDashboard(this.getFallbackAnalytics());
                }
            }

            getFallbackAnalytics() {
                return {
                    total_sales_today: 125430.50,
                    active_vehicles: 24,
                    active_customers: 1234,
                    completed_orders: 89,
                    collection_rate: 92.5
                };
            }

            updateKPIDashboard(data) {
                const kpiMappings = {
                    'sales': { value: data.total_sales_today || 0, format: 'currency' },
                    'vehicles': { value: data.active_vehicles || 0, format: 'number' },
                    'customers': { value: data.active_customers || 0, format: 'number' },
                    'orders': { value: data.completed_orders || 0, format: 'number' },
                    'collection': { value: data.collection_rate || 0, format: 'percentage' }
                };

                Object.entries(kpiMappings).forEach(([id, config]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        this.animateKPICounter(element, config.value, config.format);
                    }
                });
            }

            updateProductCount(count) {
                const element = document.getElementById('products-count');
                if (element) {
                    this.animateKPICounter(element, count, 'number');
                }
            }

            animateKPICounter(element, targetValue, format) {
                const startValue = 0;
                const duration = 2000;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * this.easeOutQuart(progress));
                    
                    switch (format) {
                        case 'currency':
                            element.textContent = this.formatCurrency(currentValue);
                            break;
                        case 'percentage':
                            element.textContent = currentValue + '%';
                            break;
                        default:
                            element.textContent = this.formatNumber(currentValue);
                    }

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                animate();
            }

            async renderProducts(products) {
                const productsGrid = document.getElementById('products-grid');
                if (!productsGrid) return;

                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="loading">لا توجد منتجات متاحة</div>';
                    return;
                }

                productsGrid.innerHTML = products.map((product, index) => `
                    <div class="product-card" onclick="showProductDetails('${product.id}')" style="--i: ${index};">
                        <div class="product-image">${this.getProductEmoji(product.category)}</div>
                        <div class="product-name">${product.name_ar}</div>
                        <div class="product-description">${product.name_en}</div>
                        <div class="product-meta">
                            <span class="product-price">${this.formatCurrency(product.price)}</span>
                            <span class="product-stock ${this.getStockClass(product.stock_quantity)}">
                                ${product.stock_quantity || 0} متوفر
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            getProductEmoji(category) {
                const emojis = {
                    'حلويات مبردة': '🧁',
                    'حلويات تقليدية': '🍰',
                    'شوكولاتة': '🍫',
                    'معجنات': '🥐'
                };
                return emojis[category] || '🍬';
            }

            getStockClass(quantity) {
                if (quantity === 0) return 'out';
                if (quantity < 20) return 'low';
                return '';
            }

            initializeMap() {
                const mapContainer = document.getElementById('operations-map');
                if (mapContainer && typeof L !== 'undefined') {
                    try {
                        this.map = L.map('operations-map').setView([24.7136, 46.6753], 11);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(this.map);

                        this.addMapMarkers();
                    } catch (error) {
                        console.error('Map initialization failed:', error);
                        mapContainer.innerHTML = '<div class="map-placeholder"><div style="text-align: center;"><div style="font-size: 4rem; margin-bottom: 1rem;">🗺️</div><div>خريطة العمليات التفاعلية</div></div></div>';
                    }
                }
            }

            addMapMarkers() {
                if (!this.map) return;

                const markers = [
                    { pos: [24.7236, 46.6853], type: 'vehicle', name: 'مركبة SSDP 1', status: 'active' },
                    { pos: [24.7036, 46.6653], type: 'outlet', name: 'منفذ الملز الذكي', status: 'online' },
                    { pos: [24.7336, 46.6953], type: 'delivery', name: 'توصيل عاجل 1', status: 'enroute' },
                    { pos: [24.6936, 46.6553], type: 'outlet', name: 'منفذ العليا المميز', status: 'online' },
                    { pos: [24.7136, 46.6753], type: 'headquarters', name: 'مقر BrainSAIT', status: 'online' }
                ];

                markers.forEach(marker => {
                    const icon = this.createMapMarkerIcon(marker.type, marker.status);
                    L.marker(marker.pos, { icon })
                        .addTo(this.map)
                        .bindPopup(`
                            <div style="text-align: center; padding: 0.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">${marker.name}</h4>
                                <p style="margin-bottom: 0.5rem;">الحالة: <span style="color: #10b981;">${marker.status}</span></p>
                                <p style="font-size: 0.875rem; color: #64748b;">مدعوم بـ BrainSAIT AI</p>
                            </div>
                        `);
                });
            }

            createMapMarkerIcon(type, status) {
                const icons = { vehicle: '🚛', outlet: '🏪', delivery: '📦', headquarters: '🧠' };
                const colors = { active: '#10b981', online: '#0ea5e9', enroute: '#f59e0b', offline: '#ef4444' };

                return L.divIcon({
                    html: `<div style="font-size: 20px; text-align: center; background: ${colors[status] || '#64748b'}; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${icons[type] || '📍'}</div>`,
                    iconSize: [35, 35],
                    className: 'ssdp-marker'
                });
            }

            startRealTimeUpdates() {
                this.realTimeInterval = setInterval(() => {
                    this.updateRealTimeData();
                }, 30000);
            }

            updateRealTimeData() {
                const kpiElements = ['sales', 'vehicles', 'customers', 'orders'];
                kpiElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const current = parseInt(element.textContent.replace(/[^\d]/g, ''));
                        const variation = Math.floor(Math.random() * 10) - 5;
                        const newValue = Math.max(0, current + variation);
                        
                        if (id === 'sales') {
                            element.textContent = this.formatCurrency(newValue);
                        } else {
                            element.textContent = this.formatNumber(newValue);
                        }
                    }
                });
            }

            async apiCall(endpoint, options = {}) {
                try {
                    const response = await fetch(`${this.apiBase}${endpoint}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept-Language': this.currentLang,
                            'X-BrainSAIT-Client': 'SSDP-Ultimate',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('SSDP API Call failed:', error);
                    throw error;
                }
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('ar-SA', {
                    style: 'currency',
                    currency: 'SAR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            }

            formatNumber(num) {
                return new Intl.NumberFormat('ar-SA').format(num);
            }

            easeOutQuart(t) {
                return 1 - (--t) * t * t * t;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>${this.getNotificationIcon(type)}</span>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: auto;">×</button>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
            }

            getNotificationIcon(type) {
                const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
                return icons[type] || icons.info;
            }

            hideLoadingScreen() {
                setTimeout(() => {
                    const loader = document.getElementById('loading-screen');
                    if (loader) {
                        loader.classList.add('hidden');
                    }
                }, 2000);
            }

            handleResize() {
                if (this.map) {
                    this.map.invalidateSize();
                }
            }

            handleOnline() {
                this.showNotification('تم استعادة الاتصال بالإنترنت', 'success');
                this.loadInitialData();
            }

            handleOffline() {
                this.showNotification('لا يوجد اتصال بالإنترنت - وضع عدم الاتصال', 'warning');
            }
        }

        // Global functions
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'products') {
                ssdpUltimate.loadInitialData();
            } else if (section === 'map' && ssdpUltimate.map) {
                setTimeout(() => ssdpUltimate.map.invalidateSize(), 100);
            }
        }

        function toggleLang() {
            ssdpUltimate.currentLang = ssdpUltimate.currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.setAttribute('lang', ssdpUltimate.currentLang);
            document.documentElement.setAttribute('dir', ssdpUltimate.currentLang === 'ar' ? 'rtl' : 'ltr');
            ssdpUltimate.showNotification(
                ssdpUltimate.currentLang === 'ar' ? 'تم تغيير اللغة إلى العربية' : 'Language changed to English',
                'success'
            );
        }

        function toggleTheme() {
            ssdpUltimate.currentTheme = ssdpUltimate.currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', ssdpUltimate.currentTheme);
            const themeBtn = document.querySelector('[onclick="toggleTheme()"]');
            if (themeBtn) {
                themeBtn.textContent = ssdpUltimate.currentTheme === 'light' ? '🌙' : '☀️';
            }
            ssdpUltimate.showNotification(
                ssdpUltimate.currentTheme === 'dark' ? 'تم تفعيل المظهر الداكن' : 'تم تفعيل المظهر الفاتح',
                'success'
            );
        }

        function showNotifications() {
            ssdpUltimate.showNotification('لديك 5 إشعارات جديدة', 'info');
        }

        function showProfile() {
            ssdpUltimate.showNotification('عرض الملف الشخصي', 'info');
        }

        function showKPIDetails(kpi) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            const kpiData = {
                sales: { title: 'تفاصيل المبيعات', content: 'إجمالي المبيعات اليوم مع تحليل مفصل للأداء' },
                vehicles: { title: 'تفاصيل المركبات', content: 'حالة المركبات النشطة ومواقعها الحالية' },
                customers: { title: 'تفاصيل العملاء', content: 'العملاء النشطون وتحليل سلوك الشراء' },
                orders: { title: 'تفاصيل الطلبات', content: 'الطلبات المكتملة وحالة التوصيل' }
            };
            
            title.textContent = kpiData[kpi]?.title || 'تفاصيل';
            body.innerHTML = `<p>${kpiData[kpi]?.content || 'تفاصيل إضافية'}</p>`;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function refreshProducts() {
            ssdpUltimate.loadInitialData();
            ssdpUltimate.showNotification('تم تحديث المنتجات', 'success');
        }

        function addProduct() {
            ssdpUltimate.showNotification('إضافة منتج جديد', 'info');
        }

        function showProductDetails(id) {
            ssdpUltimate.showNotification(`عرض تفاصيل المنتج: ${id}`, 'info');
        }

        function showAnalyticsDetail(type) {
            ssdpUltimate.showNotification(`عرض تحليلات: ${type}`, 'info');
        }

        // Initialize
        let ssdpUltimate;
        document.addEventListener('DOMContentLoaded', () => {
            ssdpUltimate = new SSDPUltimate();
        });
    </script>
</body>
</html>
